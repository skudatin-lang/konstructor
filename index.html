<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Конструктор заказа 3D-модели</title>
    <style>
        /* ... (остальные стили остаются без изменений) ... */
        
        /* Обновленные стили для категорий */
        .category-info {
            padding: 20px;
            min-height: 160px; /* Фиксированная высота для всех карточек */
            display: flex;
            flex-direction: column;
        }
        
        .category-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 20px;
            line-height: 1.3;
            height: 52px; /* Фиксированная высота для 2 строк */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .category-description {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 10px;
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }
        
        .category-price {
            font-weight: 700;
            color: #3498db;
            font-size: 22px;
            margin-top: auto; /* Прижимаем цену к низу */
        }
        
        .category-price .original {
            font-size: 16px;
            color: #95a5a6;
            text-decoration: line-through;
            margin-right: 8px;
        }
        
        /* Стили для моделей */
        .model-info {
            padding: 20px;
            min-height: 120px;
        }
        
        .model-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 18px;
            line-height: 1.3;
            height: 46px; /* Фиксированная высота для 2 строк */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* ... (остальные стили без изменений) ... */
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .category-name,
            .model-name {
                height: auto;
                -webkit-line-clamp: 3;
            }
            
            .category-info {
                min-height: 140px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- ... (остальной HTML код без изменений до шага 2.1) ... -->

<!-- Экран 2.1: Выбор модели внутри категории -->
<div id="step2_1" class="screen models-screen">
    <div class="screen-title">
        <button class="back-to-categories" onclick="backToCategories()">
            <i class="fas fa-arrow-left"></i> К категориям
        </button>
        <span id="modelsTitle">Выберите модель</span>
    </div>
    
    <!-- Для индивидуальных моделей - только одна карточка -->
    <div class="models-grid" id="modelsGrid">
        <div class="loading">
            <i class="fas fa-spinner"></i>
            <div>Загрузка моделей...</div>
        </div>
    </div>
    
    <!-- Секция для индивидуальной модели -->
    <div id="individualModelSection" style="display: none;">
        <div class="config-section">
            <div class="config-group">
                <div class="config-title">Индивидуальная модель</div>
                <div style="text-align: center; margin: 30px 0;">
                    <div style="max-width: 400px; margin: 0 auto 20px;">
                        <img src="" id="individualModelImage" 
                             style="width: 100%; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"
                             alt="Индивидуальная модель">
                    </div>
                    <div style="font-size: 18px; color: #2c3e50; font-weight: 600;">
                        <span id="individualModelTitle">Индивидуальная модель</span>
                    </div>
                    <div style="color: #7f8c8d; margin-top: 10px;">
                        Вы выбрали создание индивидуальной модели. Загрузите фото для начала работы.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="photoUploadSection" style="display: none;">
        <div class="photo-upload-section">
            <div class="photo-upload-box" onclick="document.getElementById('photoInput').click()">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="upload-text">
                    <strong>Загрузите фото для модели</strong>
                </div>
                <div class="upload-hint">
                    Нажмите или перетащите файл сюда<br>
                    Рекомендуется: JPG, PNG, до 5MB
                </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
            <div id="photoPreview" class="photo-preview"></div>
        </div>
    </div>
    
    <div style="text-align: center; margin: 40px 0;">
        <button class="btn btn-secondary" onclick="backToCategories()">
            <i class="fas fa-arrow-left"></i> Назад
        </button>
        <button class="btn" onclick="nextStep(3)" id="next2_1" disabled>
            <i class="fas fa-sliders-h"></i> Настроить проект
        </button>
    </div>
</div>

<!-- ... (остальной HTML код без изменений) ... -->

<script>
    // ... (остальной JavaScript код без изменений до функции renderModels) ...
    
    // Рендер моделей внутри категории
    function renderModels() {
        const modelsGrid = document.getElementById('modelsGrid');
        const individualSection = document.getElementById('individualModelSection');
        
        modelsGrid.innerHTML = '';
        individualSection.style.display = 'none';
        
        // Если это индивидуальная модель, показываем специальную секцию
        if (state.projectType === 'individual') {
            // Скрываем стандартную сетку моделей
            modelsGrid.style.display = 'none';
            individualSection.style.display = 'block';
            
            // Находим категорию
            const category = categoriesConfig[state.selectedGender]?.find(cat => cat.id === state.selectedCategory);
            if (category) {
                // Устанавливаем изображение категории
                document.getElementById('individualModelImage').src = category.imageUrl;
                document.getElementById('individualModelTitle').textContent = `Индивидуальная модель (${category.name.toLowerCase()})`;
                
                // Автоматически выбираем эту модель
                state.selectedModel = 'individual_' + state.selectedCategory;
                
                // Активируем кнопку перехода к настройкам
                document.getElementById('next2_1').disabled = false;
                
                // Показываем секцию загрузки фото
                document.getElementById('photoUploadSection').style.display = 'block';
                
                // Обновляем доступные высоты в зависимости от категории
                updateHeightOptions(state.selectedCategory);
            }
            return;
        }
        
        // Для готовых моделей показываем стандартную сетку
        modelsGrid.style.display = 'grid';
        
        // Получаем доступные модели
        const availableModels = getAvailableModels();
        
        if (availableModels.length === 0) {
            modelsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d;">Нет доступных моделей в этой категории</div>';
            return;
        }
        
        // Рендерим модели
        availableModels.forEach(model => {
            const div = document.createElement('div');
            div.className = 'model-card';
            div.dataset.modelId = model.id;
            div.innerHTML = `
                <div class="model-image">
                    <img src="${model.imageUrl}" 
                         alt="${model.name}"
                         loading="lazy"
                         onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNGRjgiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzMzMyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5Nb2RlbDwvdGV4dD48L3N2Zz4='">
                </div>
                <div class="model-info">
                    <div class="model-name">${model.name}</div>
                    <div class="model-style">
                        ${model.style === 'neutral' ? 'Нейтральный' : 
                          model.style === 'business' ? 'Деловой' : 
                          model.style === 'free' ? 'Свободный' :
                          model.style === 'modern' ? 'Модерн' :
                          model.style === 'classic' ? 'Классика' : 'Стандарт'}
                    </div>
                </div>
            `;
            
            div.onclick = () => {
                // Снимаем выделение со всех моделей
                document.querySelectorAll('.model-card').forEach(el => el.classList.remove('selected'));
                
                // Выделяем выбранную
                div.classList.add('selected');
                
                // Запоминаем выбор
                state.selectedModel = model.id;
                
                // Активируем кнопку перехода к настройкам
                document.getElementById('next2_1').disabled = false;
                
                // Показываем секцию загрузки фото
                document.getElementById('photoUploadSection').style.display = 'block';
                
                // Обновляем доступные высоты в зависимости от категории
                updateHeightOptions(state.selectedCategory);
            };
            
            modelsGrid.appendChild(div);
        });
    }
    
    // ... (остальной JavaScript код без изменений) ...
</script>
</body>
</html>