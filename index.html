<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конструктор заказа 3D-модели</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Прогресс-бар -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-step active">
            <div class="step-circle">1</div>
            <div class="step-label">Тип модели</div>
        </div>
        <div class="progress-step">
            <div class="step-circle">2</div>
            <div class="step-label">Категория</div>
        </div>
        <div class="progress-step">
            <div class="step-circle">3</div>
            <div class="step-label">Модель</div>
        </div>
        <div class="progress-step">
            <div class="step-circle">4</div>
            <div class="step-label">Настройка</div>
        </div>
        <div class="progress-step">
            <div class="step-circle">5</div>
            <div class="step-label">Заказ</div>
        </div>
    </div>

    <!-- Экран 1: Тип модели -->
    <div id="step1" class="screen active">
        <div class="screen-title">Выберите тип модели</div>
        <div class="project-type-container">
            <div class="project-type-card" onclick="selectProjectType('ready')">
                <div class="price-badge">скидка 50%</div>
                <h3>1. Готовая модель с лицом по фото</h3>
                <p>Выберите готовую модель из библиотеки и измените ей лицо в соответствии с вашим фото</p>
                <div class="photo-note">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Требуется качественное фото в фас. При непригодном фото — возможны доработки за дополнительную плату.</div>
                </div>
            </div>
            <div class="project-type-card" onclick="selectProjectType('individual')">
                <div class="price-badge">стандартная цена</div>
                <h3>2. Индивидуальная модель по фото</h3>
                <p>Создайте свою индивидуальную модель в соответствии вашим фото</p>
                <div class="photo-note">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Требуется чёткое фото в 3/4. При непригодном фото — возврат оплаты и расторжение договора.</div>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin: 40px 0;">
            <button class="btn" onclick="nextStep(2)" id="next1" disabled>
                <i class="fas fa-cogs"></i> Выбрать категорию
            </button>
        </div>
    </div>

    <!-- Экран 2: Выбор категории -->
    <div id="step2" class="screen">
        <div class="screen-title">Выберите категорию модели</div>
        <div class="category-section">
            <h3>Мужские модели</h3>
            <div class="category-grid" id="maleCategories">
                <div class="loading"><i class="fas fa-spinner"></i><div>Загрузка категорий...</div></div>
            </div>
        </div>
        <div class="category-section">
            <h3>Женские модели</h3>
            <div class="category-grid" id="femaleCategories">
                <div class="loading"><i class="fas fa-spinner"></i><div>Загрузка категорий...</div></div>
            </div>
        </div>
        <div style="text-align: center; margin: 40px 0;">
            <button class="btn btn-secondary" onclick="prevStep(1)"><i class="fas fa-arrow-left"></i> Назад</button>
            <button class="btn" onclick="goToModelsScreen()" id="next2" disabled><i class="fas fa-arrow-right"></i> Выбрать модель</button>
        </div>
    </div>

    <!-- Экран 2.1: Выбор модели -->
    <div id="step2_1" class="screen models-screen">
        <div class="screen-title">
            <button class="back-to-categories" onclick="backToCategories()"><i class="fas fa-arrow-left"></i> К категориям</button>
            <span id="modelsTitle">Выберите модель</span>
        </div>
        <div id="modelsContainer">
            <div class="models-grid" id="modelsGrid">
                <div class="loading"><i class="fas fa-spinner"></i><div>Загрузка моделей...</div></div>
            </div>
            <div id="individualModelContainer" style="display: none;">
                <div class="individual-model-card">
                    <div class="model-card selected">
                        <div class="model-image"><img id="individualModelImage" src="" alt="Индивидуальная модель"></div>
                        <div class="model-info">
                            <div class="model-name" id="individualModelName">Индивидуальная модель</div>
                            <p style="color: #5a6c7d; margin: 10px 0;">Вы выбрали индивидуальную модель. Загрузите фото для создания уникальной 3D-модели.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="photoUploadSection" style="display: none;">
            <div class="photo-upload-section">
                <div class="photo-upload-box" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div class="upload-text"><strong>Загрузите до 5 фото для модели</strong></div>
                    <div class="upload-hint">Нажмите или перетащите файлы сюда<br>Поддерживаемые форматы: JPG, PNG (до 5 МБ каждый)</div>
                </div>
                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;" onchange="handlePhotoUpload(event)">
                <div id="photoPreview" class="photo-preview-grid"></div>
            </div>
        </div>
        <div style="text-align: center; margin: 40px 0;">
            <button class="btn btn-secondary" onclick="backToCategories()"><i class="fas fa-arrow-left"></i> Назад</button>
            <button class="btn" onclick="nextStep(3)" id="next2_1" disabled><i class="fas fa-sliders-h"></i> Настроить проект</button>
        </div>
    </div>

    <!-- Экран 3: Настройка -->
    <div id="step3" class="screen">
        <div class="screen-title">Настройте стоимость вашего проекта</div>
        <div class="config-section">
            <div class="config-group">
                <div class="config-title">Высота модели</div>
                <div class="option-group" id="heightGroup">
                    <div class="option-btn" data-value="10">10 см</div>
                    <div class="option-btn" data-value="15">15 см</div>
                    <div class="option-btn" data-value="18">18 см</div>
                    <div class="option-btn" data-value="20">20 см</div>
                    <div class="option-btn" data-value="25">25 см</div>
                </div>
            </div>
            <div class="config-group">
                <div class="config-title">Сроки изготовления</div>
                <div class="option-group" id="daysGroup">
                    <div class="option-btn" data-value="30">30 дн</div>
                    <div class="option-btn" data-value="21">21 дн</div>
                    <div class="option-btn" data-value="14">14 дн</div>
                    <div class="option-btn" data-value="7">7 дн</div>
                    <div class="option-btn" data-value="3">3 дн</div>
                </div>
            </div>
            <div class="config-group">
                <div class="config-title">Эксклюзивные права на использование</div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="exclusiveToggle" onchange="toggleExclusive(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">ДА (+60% к стоимости)</span>
                    </div>
                </div>
            </div>
            <div class="config-group">
                <div class="config-title">Печать модели</div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="printingToggle" onchange="togglePrinting(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">ДА (срок +14 дн)</span>
                    </div>
                </div>
                <div id="printingPrice" style="color: #3498db; font-size: 16px; margin-top: 10px; display: none;">
                    Стоимость: <span id="printingCost">0</span> руб
                </div>
            </div>
            <div class="config-group">
                <div class="config-title">Покраска модели</div>
                <div class="toggle-group">
                    <div class="toggle-item">
                        <label class="toggle-switch">
                            <input type="checkbox" id="paintingToggle" onchange="togglePainting(this.checked)" disabled>
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">ДА (срок +14 дн)</span>
                    </div>
                </div>
                <div id="paintingPrice" style="color: #3498db; font-size: 16px; margin-top: 10px; display: none;">
                    Стоимость: <span id="paintingCost">0</span> руб
                </div>
            </div>
        </div>
        <div class="summary-box">
            <div class="summary-price"><span id="totalPrice">0</span> ₽</div>
            <div class="summary-days">Итоговый срок: <span id="finalDays">14</span> дней</div>
        </div>
        <div style="text-align: center; margin: 40px 0;">
            <button class="btn btn-secondary" onclick="prevStep(2)"><i class="fas fa-arrow-left"></i> Назад</button>
            <button class="btn" onclick="nextStep(4)"><i class="fas fa-shopping-cart"></i> Оформить заказ</button>
        </div>
    </div>

    <!-- Экран 4: Заказ -->
    <div id="step4" class="screen">
        <div class="screen-title">Ваш заказ</div>
        <div class="config-section">
            <div class="config-group">
                <div class="config-title">Информация о заказе</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div><strong>Тип модели:</strong><br><span id="sumType"> --- </span></div>
                    <div><strong>Категория:</strong><br><span id="sumCategory"> --- </span></div>
                    <div><strong>Модель:</strong><br><span id="sumModel"> --- </span></div>
                    <div><strong>Высота:</strong><br><span id="sumHeight"> --- </span> см</div>
                    <div><strong>Срок:</strong><br><span id="sumFinalDays"> --- </span> дней</div>
                    <div><strong>Эксклюзив:</strong><br><span id="sumExcl">НЕТ</span></div>
                    <div><strong>Печать:</strong><br><span id="sumPrint">НЕТ</span></div>
                    <div><strong>Покраска:</strong><br><span id="sumPaint">НЕТ</span></div>
                    <div><strong>Стоимость:</strong><br><span id="sumPrice" style="font-weight: 700; font-size: 22px; color: #2ecc71;">0</span> ₽</div>
                </div>
            </div>
            <div class="config-group">
                <div class="config-title">Контактная информация</div>
                <p style="color: #7f8c8d; margin-bottom: 25px;">
                    Для оформления заказа заполните анкету. Продолжая вы соглашаетесь на обработку персональных данных
                </p>
                <div class="form-group">
                    <label class="form-label">Введите ваше имя</label>
                    <input type="text" class="form-input" id="name" placeholder="Иван Иванов">
                </div>
                <div class="form-group">
                    <label class="form-label">Введите ваш WhatsApp / Telegram</label>
                    <input type="text" class="form-input" id="contact" placeholder="@username или +79123456789">
                </div>
                <div class="form-group">
                    <label class="form-label">Комментарий к заказу (необязательно)</label>
                    <textarea class="form-input" id="comment" rows="3" placeholder="Дополнительные пожелания..."></textarea>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="agree" style="width: 20px; height: 20px;">
                    <label for="agree">Согласен на обработку персональных данных</label>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin: 40px 0;">
            <button class="btn btn-secondary" onclick="prevStep(3)"><i class="fas fa-arrow-left"></i> Назад</button>
            <button class="btn btn-success" onclick="submitOrderFromForm()" id="submitOrder"><i class="fas fa-check-circle"></i> Оформить заказ</button>
        </div>
    </div>

    <!-- Экран 5: Договор -->
    <div id="contractScreen" class="screen"></div>

    <!-- Подключение модулей -->
    <script src="config.js"></script>
    <script src="gsheet.js"></script>
    <script src="pricing.js"></script>
    <script src="ui.js"></script>
    <script src="telegram.js"></script>
    <script src="contract.js"></script>

    <script>
        let cachedData = null;
        let currentState = {
            projectType: null,
            selectedGender: null,
            selectedCategory: null,
            selectedModel: null,
            uploadedPhotos: [],
            height: '15',
            baseDays: '14',
            exclusive: false,
            printing: false,
            painting: false,
            customerName: '',
            customerContact: '',
            comment: ''
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                cachedData = await loadAllData();
                setupConfigOptions();
                updatePrice();
                showNotification('Данные успешно загружены!', false);
            } catch (e) {
                showNotification('Ошибка загрузки Google Sheets', true);
                console.error(e);
            }
        });

        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `notification ${isError ? 'error' : ''}`;
            notification.innerHTML = `
                <i class="fas ${isError ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>